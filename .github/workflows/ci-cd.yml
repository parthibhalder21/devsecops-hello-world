# .github/workflows/ci-cd.yml
name: DevSecOps Microservice Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY_URL: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: devsecops-hello-world

# Grants write access to the GitHub Package Registry (GHCR)
permissions:
  contents: read
  packages: write

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    # SAST (Static Analysis - Bandit)
    - name: Run SAST Scan (Bandit)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - run: pip install bandit && bandit -r app.py --format screen -lll
    
    # Build Docker Image
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_URL }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and Tag Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
    # SCA/Container Scanning (Trivy)
    - name: Run Trivy vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: 'table'
        exit-code: '1' 
        severity: 'CRITICAL,HIGH'
        
  deploy-staging-and-dast:
    needs: build-and-scan
    runs-on: ubuntu-latest
    environment: Staging
    steps:
    - uses: actions/checkout@v4
    
    # STEP 1: DEPLOYMENT SIMULATION
    # This simulates the entire complex K8s deployment process (Kubeconfig, TLS, apply)
    - name: Simulate Successful Deployment to Staging Kubernetes
      run: |
        IMAGE_TAG=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        # Simulate the image tag replacement step
        echo "Running sed to inject image tag: $IMAGE_TAG into k8s/deployment.yaml"
        
        # Simulate successful kubectl apply command
        echo "Deployment to Staging Kubernetes cluster applied successfully."
        echo "The application is now accessible at http://staging-app-url.com"
        
    # STEP 2: DAST SIMULATION
    # This simulates a successful DAST scan without needing to connect to the live app URL
    - name: Simulate Successful DAST Scan (OWASP ZAP Baseline)
      run: |
        echo "Running OWASP ZAP Baseline Scan on http://staging-app-url.com"
        echo "Scan completed in 45 seconds. No critical or high alerts found."
        echo "DAST security gate passed."
        
  deploy-production:
    needs: deploy-staging-and-dast
    runs-on: ubuntu-latest
    environment: 
      name: Production
      # This requires manual approval on GitHub Actions
    steps:
    - name: Deployment Step (Requires Manual Approval)
      run: echo "Production deployment ready for approval."
