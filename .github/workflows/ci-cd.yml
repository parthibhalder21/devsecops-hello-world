# .github/workflows/ci-cd.yml
name: DevSecOps Microservice Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY_URL: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: devsecops-hello-world

# FIX 1: Grants write access to the GitHub Package Registry (ghcr.io)
permissions:
  contents: read
  packages: write

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    # SAST (Static Analysis - Bandit)
    - name: Run SAST Scan (Bandit)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - run: pip install bandit && bandit -r app.py --format screen -lll
    
    # Build Docker Image
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_URL }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and Tag Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
    # SCA/Container Scanning (Trivy)
    - name: Run Trivy vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: 'table'
        exit-code: '1' 
        severity: 'CRITICAL,HIGH'
        
  deploy-staging-and-dast:
    needs: build-and-scan
    runs-on: ubuntu-latest
    environment: Staging
    steps:
    - uses: actions/checkout@v4
    
    # FIX 2: Manually loads kubectl and forces the use of the KUBECONFIG secret file
    - name: Install kubectl and Configure Kubeconfig
      uses: azure/setup-kubectl@v4 # Installs kubectl
    - run: |
        # Write the KUBECONFIG secret value into a temporary file
        echo "${{ secrets.KUBECONFIG }}" > kubeconfig.yaml
        
        # Set the KUBECONFIG environment variable to use the file
        export KUBECONFIG=kubeconfig.yaml
        
        # Deployment commands
        IMAGE_TAG=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        sed -i "s|__IMAGE_TAG__|$IMAGE_TAG|g" k8s/deployment.yaml
        echo "Applying deployment to Staging Kubernetes cluster..." 
        
        # FIX 3: Added --validate=false to bypass Killercoda's validation bug
        kubectl apply -f k8s/ --namespace=staging --validate=false
        
    # DAST (Dynamic Analysis - OWASP ZAP)
    - name: Run DAST Scan (OWASP ZAP Baseline)
      uses: zaproxy/action-baseline@v0.11.0
      with:
        target: 'http://staging-app-url.com' # Placeholder target
        fail_action: false 
        
  deploy-production:
    needs: deploy-staging-and-dast
    runs-on: ubuntu-latest
    environment: 
      name: Production
    steps:
    - name: Deployment Step (Requires Manual Approval)
      run: echo "Production deployment ready for approval."
